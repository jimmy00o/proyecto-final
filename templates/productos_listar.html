{% extends 'baseadmin.html' %}

{% block title %}Lista de Productos{% endblock %}

{% block body %}
<div class="container mt-4">
  <div class="card shadow-sm">

    <div class="card-header bg-danger bg-opacity-25 text-center d-flex justify-content-between align-items-center">

      <!-- Título con Tooltip -->
      <h4 class="m-0 flex-grow-1 text-center"
          data-bs-toggle="tooltip"
          title="Listado general de productos registrados en el sistema">
        Lista de Producto
      </h4>

      <!-- BOTÓN EXPORTAR A EXCEL -->
      <a href="{{ url_for('exportar_productos') }}"
         class="btn btn-success btn-sm"
         data-bs-toggle="tooltip"
         title="Descargar listado en formato Excel">
        <i class="bi bi-file-earmark-excel"></i> Exportar Excel
      </a>

    </div>

    <div class="card-body">

      <!-- SweetAlert2 Flash -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
          <script>
            Swal.fire({
              icon: "{{ category }}",
              title: "{{ message }}",
              showConfirmButton: false,
              timer: 2000
            });
          </script>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="table-responsive">
        <table id="tablaProductos" class="table table-bordered table-striped align-middle">

          <thead class="table-dark">
            <tr>
              <th data-bs-toggle="tooltip" title="Identificador único del producto">ID</th>
              <th data-bs-toggle="tooltip" title="Nombre del producto">Nombre</th>
              <th data-bs-toggle="tooltip" title="Precio de venta del producto">Precio</th>
              <th data-bs-toggle="tooltip" title="Descripción detallada del producto">Descripción</th>
              <th data-bs-toggle="tooltip" title="Fecha de registro del producto">Fecha</th>
              <th data-bs-toggle="tooltip" title="Opciones disponibles">Acciones</th>
            </tr>
          </thead>

          <tbody>
            {% for p in productos %}
            <tr>
              <td data-bs-toggle="tooltip" title="ID del producto">{{ p.id }}</td>
              <td data-bs-toggle="tooltip" title="Nombre del producto">{{ p.nombre }}</td>
              <td data-bs-toggle="tooltip" title="Precio en formato monetario">{{ '%.2f'|format(p.precio) }}</td>
              <td data-bs-toggle="tooltip" title="Descripción completa">{{ p.descripcion }}</td>
              <td data-bs-toggle="tooltip" title="Fecha de ingreso">{{ p.fecha }}</td>

              <td>
                <!-- Botón Editar -->
                <a href="{{ url_for('editar_producto', pid=p.id) }}"
                   class="btn btn-sm btn-success me-1"
                   data-bs-toggle="tooltip"
                   title="Editar este producto">
                  <i class="bi bi-pencil-square"></i>
                </a>

                <!-- Botón Eliminar -->
                <form action="{{ url_for('eliminar_producto', pid=p.id) }}"
                      method="post"
                      class="d-inline eliminar-form">
                  <button type="submit"
                          class="btn btn-sm btn-danger btn-eliminar"
                          data-nombre="{{ p.nombre }}"
                          data-bs-toggle="tooltip"
                          title="Eliminar este producto">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>

            {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted">No hay productos registrados.</td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // ================== DataTable ==================
  new DataTable('#tablaProductos', {
    responsive: true,
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json" },
    pageLength: 5
  });

  // ================== SweetAlert2 ==================
  document.querySelectorAll('.eliminar-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const nombre = form.querySelector('.btn-eliminar').dataset.nombre;

      Swal.fire({
        title: `¿Eliminar "${nombre}"?`,
        text: "¡Esta acción no se puede deshacer!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });
  });

  // ================== ACTIVAR TOOLTIP ==================
  const tooltipEls = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  const tooltips = [...tooltipEls].map(el => new bootstrap.Tooltip(el));

  // Permitir solo un tooltip a la vez (como tus demás pantallas)
  document.addEventListener('shown.bs.tooltip', function (event) {
    tooltips.forEach(instance => {
      if (instance._element !== event.target) {
        instance.hide();
      }
    });
  });

});
</script>

{% endblock %}
