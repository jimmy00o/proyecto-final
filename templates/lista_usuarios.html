{% extends 'baseadmin.html' %}

{% block title %}Lista de Usuarios{% endblock %}

{% block body %}
<!-- Contenedor principal -->
<div class="container mt-4">

  <!-- Encabezado con título y botones -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Lista de Usuarios</h2>
    <div>
      <!-- Botón Agregar Usuario -->
      <a href="{{ url_for('crear_usuario') }}" class="btn btn-success me-2" 
         data-bs-toggle="tooltip" data-bs-placement="top" title="Agregar un nuevo usuario">
        Agregar Usuario
      </a>
      <!-- Botón Exportar Usuarios -->
      <a href="{{ url_for('exportar_usuarios') }}" class="btn btn-primary"
         data-bs-toggle="tooltip" data-bs-placement="top" title="Exportar todos los usuarios a Excel/CSV">
        <i class="bi bi-download me-1"></i> Exportar Usuarios
      </a>
    </div>
  </div>

  <!-- Mensajes flash (ej: usuario creado o eliminado) -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          Swal.fire({
            icon: "{{ 'success' if category == 'success' else 'info' }}",
            title: "{{ message }}",
            showConfirmButton: false,
            timer: 1800
          });
        });
      </script>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Tabla con todos los usuarios -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>N°</th>
          <th>Nombre</th>
          <th>Correo</th>
          <th>Password</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usuarios %}
        <tr>
          <td>{{ u.id }}</td>
          <td>{{ u.nombre }}</td>
          <td>{{ u.email }}</td>
          <td>{{ u.password }}</td>
          <td>
            <!-- Botón para editar -->
            <a href="{{ url_for('editar_usuario', uid=u.id) }}" class="btn btn-sm btn-primary">Editar</a>
            
            <!-- Botón para eliminar con SweetAlert -->
            <form action="{{ url_for('eliminar_usuario', uid=u.id) }}" method="post" class="d-inline eliminar-form">
              <button type="submit" class="btn btn-sm btn-danger btn-eliminar" data-nombre="{{ u.nombre }}">Eliminar</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="text-center text-muted">No hay usuarios registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- Scripts -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Inicializar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

    // SweetAlert para confirmar eliminación
    const formsEliminar = document.querySelectorAll('.eliminar-form');
    formsEliminar.forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault(); // Evitar envío inmediato
        const nombre = form.querySelector('.btn-eliminar').dataset.nombre;

        Swal.fire({
          title: `¿Eliminar al usuario "${nombre}"?`,
          text: "Esta acción no se puede deshacer.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Sí, eliminar",
          cancelButtonText: "Cancelar"
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit(); // Solo se envía si confirma
          }
        });
      });
    });
  });
</script>

{% endblock %}
